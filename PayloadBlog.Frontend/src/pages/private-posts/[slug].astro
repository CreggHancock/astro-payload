---
import "../index.less";
import Layout from "../../layouts/Layout.astro";

const { slug } = Astro.params;

function setApiUrlsAsAbsolute(content: string) {
  return content.replaceAll("/api/", "http://localhost:3000/api/");
}

export const prerender = false;

var cookie = Astro.cookies.get("payload-token");

if (!cookie) {
  return Astro.redirect("/");
}

const res = await fetch("http://localhost:3000/api/private-posts", {
  credentials: "include",
  headers: {
    Cookie: `payload-token=${cookie.value};`,
  },
});

if (res.status === 403) {
  return Astro.redirect("/");
}

const posts: any = await res.json();
const { title, date, categories, content_html, image } = posts.docs.find((post: any) => post.slug === slug);
---

<Layout>
  <div class="astro-blog-detail">
    <article class="blog-item flex-col" itemscope="" itemtype="https://schema.org/Article" transition:name={slug}>
      <div class="blog-item-image">
        <img src={`http://localhost:3000${image.url}`} alt={title} />
      </div>

      <div class="blog-item-content flex-col">
        <h1 set:html={title} />

        <div class="blog-item-details flex-row">
          <span class="blog-item-date">
            <i class="fas fa-calendar"></i>
            <span>{new Date(date).toLocaleDateString("en-US")}</span>
          </span>

          <span class="blog-item-category">
            <i class="fas fa-tag"></i>
            {categories.map((category: any) => <a href={"/categories/" + category.name}>{category.name}</a>)}
          </span>
        </div>

        <div class="blog-item-text" itemprop="description">
          <div set:html={setApiUrlsAsAbsolute(content_html)} />
        </div>
      </div>
    </article>
  </div>
</Layout>
<style lang="less">
  .astro-blog-detail {
    max-width: 960px;
    width: 100%;
    margin: 0 auto;

    .blog-item {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background: #f9f9f9;

      .blog-item-image {
        aspect-ratio: 2/1;
        overflow: hidden;
        img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
      }

      .blog-item-content {
        padding: 0 1rem 3rem;
      }

      h1,
      h3 {
        margin: 0;
      }

      .blog-item-details {
        svg,
        i {
          color: var(--brand-accent);
          height: 1em;
        }
      }

      .blog-item-date,
      .blog-item-category {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.895rem;
        color: #555;

        a {
          color: var(--brand-bright-blue);
          &:hover {
            color: var(--brand-blue);
          }
        }
      }

      .blog-item-text {
        border-top: 0.125rem solid var(--border, #eee);
        padding-top: 1rem;
        line-height: 1.5;
      }
    }
  }

  @media screen and (min-width: 660px) {
    .astro-blog-detail {
      .blog-item {
        .blog-item-content {
          padding: 1rem 2rem 2rem;
        }
      }
    }
  }

  @media screen and (min-width: 1000px) {
    .astro-blog-detail {
      .blog-item {
        .blog-item-content {
          padding: 1rem 2rem 3rem;
        }
      }
    }
  }
</style>
